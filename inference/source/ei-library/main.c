/*******************************************************************************
 * Header file includes
 ******************************************************************************/
#include <inttypes.h>

#include "cybsp.h"
#include "cyhal.h"

#include "cycfg.h"
#include "cy_retarget_io.h"
#include "xensiv_bgt60trxx_mtb.h"

#define XENSIV_BGT60TRXX_CONF_IMPL
#include "presence_radar_settings.h"
#include "ei_c_wrapper.h" // Edge Impulse Model

/*******************************************************************************
* Macro Definitions
*******************************************************************************/

/* sensor SPI interface */
#define PIN_XENSIV_BGT60TRXX_SPI_SCLK       CYBSP_SPI_CLK
#define PIN_XENSIV_BGT60TRXX_SPI_MOSI       CYBSP_SPI_MOSI
#define PIN_XENSIV_BGT60TRXX_SPI_MISO       CYBSP_SPI_MISO
#define PIN_XENSIV_BGT60TRXX_SPI_CSN        CYBSP_SPI_CS

/* sensor interrupt output pin */
#define PIN_XENSIV_BGT60TRXX_IRQ            CYBSP_GPIO10
/* sensor HW reset pin */
#define PIN_XENSIV_BGT60TRXX_RSTN           CYBSP_GPIO11
/* enable 1V8 LDO on radar wingboard*/
#define PIN_XENSIV_BGT60TRXX_LDO_EN         CYBSP_GPIO5

#define XENSIV_BGT60TRXX_SPI_FREQUENCY      (25000000UL)

#define NUM_SAMPLES_PER_FRAME               (XENSIV_BGT60TRXX_CONF_NUM_RX_ANTENNAS *\
                                             XENSIV_BGT60TRXX_CONF_NUM_CHIRPS_PER_FRAME *\
                                             XENSIV_BGT60TRXX_CONF_NUM_SAMPLES_PER_CHIRP)

/*******************************************************************************
 * Global variable
 ******************************************************************************/
static cyhal_spi_t cyhal_spi;
static xensiv_bgt60trxx_mtb_t sensor;
static volatile bool data_available = false;

/* Allocate enough memory for the radar dara frame. */
static uint16_t samples[NUM_SAMPLES_PER_FRAME];

/* Interrupt handler to react on sensor indicating the availability of new data */
#if defined(CYHAL_API_VERSION) && (CYHAL_API_VERSION >= 2)
void xensiv_bgt60trxx_mtb_interrupt_handler(void *args, cyhal_gpio_event_t event)
#else
void xensiv_bgt60trxx_mtb_interrupt_handler(void *args, cyhal_gpio_irq_event_t event)
#endif
{
    CY_UNUSED_PARAMETER(args);
    CY_UNUSED_PARAMETER(event);
    data_available = true;
}


//extern bool user_button_press_onboot;
char radar_raw_data_buf[100];
//char task_accel_buffer[100];

/* Motion sensor */
/*cyhal_i2c_t i2c;
cyhal_i2c_cfg_t i2c_cfg = {
    .is_slave = false,
    .address = 0,
    .frequencyhal_hz = 400000
};*/


/* Edge Impulse */

uint16_t features[300] = { 0 };

// Sample test features
float radar_features[2018] = {
		1750, 1529, 1714, 1580, 1730, 1685, 1646, 1771, 1574, 1664, 1664, 1668, 1668, 1674, 1680, 1754, 1622, 1576, 1628, 1758, 1628, 1608, 1693, 1701, 1697, 1690, 1794, 1628, 1706, 1702, 1684, 1558, 1638, 1540, 1558, 1712, 1628, 1632, 1652, 1608, 1728, 1554, 1700, 1640, 1644, 1559, 1704, 1646, 1648, 1741, 1608, 1664, 1664, 1713, 1762, 1694, 1568, 1640, 1686, 1546, 1648, 1764, 1613, 1715, 1678, 1668, 1610, 1652, 1651, 1662, 1682, 1642, 1682, 1604, 1505, 1626, 1714, 1632, 1664, 1672, 1660, 1664, 1654, 1666, 1598, 1694, 1670, 1642, 1664, 1792, 1682, 1636, 1666, 1607, 1708, 1702, 1654, 1628, 1662, 1688, 1656, 1672, 1662, 1654, 1656, 1640, 1584, 1646, 1664, 1686, 1748, 1675, 1662, 1644, 1742, 1688, 1698, 1682, 1588, 1772, 1672, 1796, 1756, 1530, 1678, 1690, 1590, 1608, 1632, 1576, 1744, 1628, 1738, 1612, 1572, 1666, 1719, 1580, 1680, 1612, 1754, 1614, 1644, 1601, 1644, 1762, 1650, 1652, 1665, 1560, 1672, 1656, 1734, 1568, 1770, 1708, 1636, 1686, 1712, 1678, 1694, 1574, 1660, 1752, 1690, 1678, 1600, 1637, 1685, 1688, 1676, 1710, 1646, 1764, 1616, 1666, 1726, 1606, 1650, 1666, 1636, 1662, 1692, 1586, 1682, 1704, 1670, 1672, 1690, 1600, 1672, 1672, 1640, 1636, 1681, 1690, 1647, 1750, 1648, 1696, 1704, 1662, 1674, 1652, 1654, 1562, 1724, 1619, 1696, 1716, 1702, 1758, 1730, 1732, 1772, 1608, 1610, 1666, 1714, 1734, 1615, 1762, 1770, 1698, 1694, 1732, 1746, 1808, 1610, 1788, 1646, 1698, 1766, 1744, 1722, 1616, 1665, 1594, 1692, 1796, 1662, 1746, 1648, 1722, 1626, 1800, 1726, 1768, 1656, 1631, 1698, 1684, 1642, 1682, 1636, 1728, 1626, 1666, 1656, 1708, 1670, 1610, 1670, 1577, 1580, 1740, 1624, 1572, 1749, 1682, 1634, 1645, 1726, 1672, 1700, 1649, 1640, 1542, 1598, 1624, 1654, 1612, 1646, 1554, 1586, 1640, 1688, 1716, 1574, 1701, 1770, 1622, 1660, 1678, 1712, 1672, 1710, 1600, 1762, 1577, 1598, 1544, 1632, 1688, 1642, 1644, 1590, 1754, 1590, 1632, 1540, 1690, 1660, 1661, 1566, 1568, 1558, 1568, 1694, 1590, 1580, 1618, 1762, 1680, 1582, 1650, 1518, 1652, 1557, 1482, 1634, 1656, 1702, 1618, 1612, 1610, 1646, 1582, 1584, 1657, 1693, 1620, 1690, 1572, 1664, 1668, 1628, 1714, 1722, 1596, 1558, 1711, 1744, 1732, 1654, 1728, 1702, 1606, 1710, 1674, 1665, 1734, 1686, 1610, 1662, 1710, 1591, 1678, 1600, 1602, 1640, 1720, 1650, 1605, 1660, 1686, 1638, 1632, 1616, 1762, 1638, 1674, 1756, 1726, 1766, 1736, 1708, 1660, 1582, 1778, 1764, 1696, 1691, 1730, 1693, 1581, 1710, 1685, 1588, 1744, 1685, 1530, 1646, 1652, 1688, 1731, 1768, 1606, 1730, 1660, 1672, 1690, 1817, 1666, 1666, 1652, 1682, 1634, 1650, 1642, 1702, 1730, 1705, 1723, 1692, 1665, 1682, 1676, 1666, 1742, 1804, 1652, 1722, 1732, 1662, 1648, 1713, 1620, 1584, 1661, 1626, 1766, 1656, 1686, 1630, 1685, 1775, 1770, 1680, 1724, 1754, 1709, 1628, 1684, 1655, 1650, 1660, 1634, 1550, 1606, 1584, 1668, 1534, 1620, 1676, 1554, 1620, 1536, 1558, 1628, 1584, 1678, 1564, 1532, 1599, 1682, 1520, 1608, 1558, 1656, 1709, 1572, 1562, 1678, 1638, 1716, 1538, 1576, 1506, 1534, 1612, 1570, 1732, 1666, 1624, 1636, 1448, 1609, 1636, 1562, 1623, 1662, 1564, 1624, 1578, 1590, 1614, 1500, 1604, 1514, 1598, 1591, 1524, 1616, 1674, 1626, 1566, 1560, 1737, 1629, 1692, 1568, 1568, 1544, 1620, 1544, 1603, 1582, 1574, 1612, 1540, 1654, 1632, 1684, 1616, 1668, 1745, 1592, 1508, 1561, 1564, 1538, 1598, 1596, 1588, 1479, 1595, 1584, 1648, 1623, 1396, 1520, 1476, 1506, 1682, 1516, 1686, 1691, 1796, 1684, 1636, 1678, 1640, 1733, 1834, 1656, 1558, 1809, 1482, 1848, 1332, 1880, 1466, 1892, 1466, 1908, 1624, 1718, 1694, 1454, 1847, 1439, 1773, 1568, 1772, 1726, 2213, 1582, 2086, 1454, 1652, 1788, 1836, 1844, 1512, 2020, 1732, 1814, 2060, 1688, 1600, 1737, 2058, 1722, 1566, 1752, 1956, 1866, 1774, 1824, 1648, 1776, 1580, 2004, 2052, 1823, 1857, 1736, 1726, 1810, 1604, 1576, 1478, 1530, 1612, 1774, 1816, 1814, 1686, 1786, 1744, 1713, 1698, 1618, 1618, 1358, 1258, 1368, 1376, 1772, 1956, 2032, 2094, 2184, 2045, 1865, 1826, 1680, 1601, 1700, 1560, 1702, 1671, 1708, 1700, 1766, 1780, 1806, 1893, 1828, 1870, 1932, 1991, 1982, 2056, 2022, 1946, 1924, 1942, 1890, 1856, 1904, 1854, 1910, 1790, 1809, 1746, 1616, 1738, 1720, 1646, 1530, 1682, 1508, 1582, 1600, 1482, 1468, 1528, 1558, 1362, 1472, 1475, 1458, 1368, 1398, 1340, 1360, 1412, 1300, 1407, 1408, 1424, 1399, 1328, 1486, 1512, 1526, 1562, 1622, 1714, 1610, 1732, 1732, 1714, 1693, 1750, 1658, 1852, 1680, 1791, 1708, 1786, 1788, 1798, 1676, 1666, 1722, 1664, 1636, 1598, 1534, 1578, 1710, 1520, 1616, 1644, 1608, 1596, 1702, 1754, 1710, 1774, 1786, 1716, 1794, 1802, 1816, 1768, 1754, 1758, 1798, 1710, 1712, 1620, 1728, 1690, 1686, 1724, 1778, 1750, 1652, 1576, 1741, 1720, 1740, 1756, 1649, 1746, 1710, 1722, 1641, 1734, 1788, 1821, 1882, 1844, 1854, 1716, 1878, 1888, 1862, 1834, 1822, 1850, 1800, 1914, 1802, 1902, 1862, 1780, 1958, 1834, 1965, 1920, 1886, 1840, 1886, 1790, 1830, 1938, 1904, 1800, 1731, 1766, 1788, 1784, 1854, 1752, 1764, 1742, 1764, 1884, 1919, 1701, 1804, 1776, 1713, 1764, 1930, 1716, 1818, 1816, 1778, 1954, 1858, 1882, 2020, 1824, 2058, 2166, 1976, 2026, 2064, 2010, 2072, 2084, 1852, 1990, 1952, 1762, 1844, 1772, 1756, 1864, 1798, 1780, 1812, 1803, 1922, 1698, 1822, 1842, 1928, 1844, 1966, 1926, 2028, 2030, 1988, 1952, 1950, 1966, 1907, 2020, 1949, 2006, 2050, 1988, 2026, 1988, 2068, 1978, 2076, 2050, 2012, 1940, 2082, 1982, 2101, 2049, 1933, 2148, 2011, 1970, 2036, 1952, 2034, 2098, 1970, 1931, 2128, 2124, 2010, 2062, 1981, 2001, 2009, 1938, 2014, 1944, 1822, 1944, 1944, 1812, 1760, 1752, 1826, 1720, 1694, 1610, 1694, 1654, 1560, 1760, 1612, 1576, 1646, 1656, 1644, 1718, 1716, 1710, 1636, 1690, 1774, 1899, 1888, 1876, 1804, 1949, 1974, 1968, 1861, 2050, 1885, 1914, 2048, 1984, 1890, 1938, 2048, 1778, 1888, 1904, 1956, 1784, 1886, 1943, 1666, 1708, 1711, 1794, 1644, 1736, 1714, 1724, 1550, 1620, 1522, 1642, 1524, 1452, 1430, 1464, 1422, 1326, 1412, 1358, 1342, 1360, 1294, 1340, 1304, 1404, 1400, 1322, 1364, 1292, 1352, 1327, 1479, 1386, 1416, 1364, 1330, 1366, 1440, 1384, 1504, 1296, 1324, 1471, 1462, 1407, 1404, 1448, 1452, 1482, 1604, 1449, 1608, 1596, 1698, 1568, 1676, 1764, 1778, 1930, 1848, 1764, 1768, 1776, 1832, 1850, 1873, 1760, 1954, 1868, 1771, 1780, 1830, 1836, 1916, 1795, 1842, 1894, 1770, 1860, 1868, 1878, 1938, 1900, 1902, 1938, 2082, 2024, 1948, 2046, 1990, 2026, 1976, 2044, 2140, 2026, 2114, 2082, 2099, 2130, 2126, 2122, 2210, 2134, 2082, 2191, 2069, 1994, 2110, 2110, 2044, 2174, 2140, 1972, 2036, 1924, 2126, 2048, 2012, 2080, 2118, 2082, 2118, 1998, 2082, 2014, 2000, 2074, 2098, 2168, 2020, 2056, 2188, 2052, 2038, 2097, 2104, 2122, 2034, 2115, 2024, 2082, 2044, 2160, 2074, 2120, 2144, 2080, 2012, 2122, 2110, 2034, 1860, 1977, 1964, 1965, 1860, 2050, 1827, 1882, 1888, 1936, 1832, 1770, 1852, 1772, 1858, 1791, 1752, 1782, 1696, 1764, 1866, 1844, 1724, 1758, 1762, 1708, 1688, 1640, 1666, 1687, 1761, 1708, 1688, 1634, 1626, 1634, 1586, 1570, 1478, 1641, 1545, 1622, 1519, 1500, 1506, 1472, 1546, 1590, 1641, 1590, 1612, 1494, 1520, 1570, 1615, 1524, 1688, 1576, 1433, 1544, 1588, 1514, 1514, 1550, 1678, 1494, 1558, 1560, 1593, 1612, 1443, 1510, 1530, 1584, 1538, 1508, 1496, 1524, 1578, 1590, 1486, 1545, 1558, 1626, 1632, 1525, 1520, 1620, 1512, 1504, 1545, 1510, 1540, 1632, 1518, 1519, 1506, 1638, 1496, 1562, 1600, 1666, 1468, 1626, 1594, 1558, 1591, 1612, 1578, 1531, 1548, 1434, 1574, 1468, 1561, 1672, 1616, 1588, 1772, 1604, 1702, 1812, 1884, 1786, 1962, 1796, 1892, 1840, 1876, 1894, 1850, 1866, 1910, 1858, 1836, 1784, 1676, 1704, 1652, 1660, 1560, 1577, 1644, 1590, 1560, 1444, 1520, 1485, 1490, 1440, 1462, 1463, 1500, 1632, 1466, 1412, 1326, 1344, 1550, 1456, 1482, 1390, 1420, 1510, 1433, 1396, 1398, 1424, 1382, 1470, 1456, 1569, 1431, 1402, 1423, 1458, 1472, 1430, 1543, 1566, 1508, 1498, 1596, 1604, 1520, 1526, 1504, 1661, 1612, 1650, 1596, 1678, 1656, 1812, 1712, 1862, 1808, 1826, 1932, 1825, 1720, 1890, 1896, 1862, 1910, 1880, 1768, 1820, 1788, 1908, 1844, 1772, 1813, 1800, 1766, 1820, 1672, 1746, 1752, 1660, 1596, 1750, 1682, 1712, 1636, 1658, 1670, 1654, 1642, 1717, 1600, 1686, 1614, 1644, 1662, 1760, 1640, 1592, 1682, 1654, 1710, 1654, 1592, 1644, 1651, 1644, 1616, 1506, 1572, 1598, 1639, 1616, 1530, 1622, 1709, 1592, 1700, 1520, 1532, 1582, 1558, 1638, 1580, 1514, 1618, 1708, 1694, 1554, 1548, 1626, 1590, 1594, 1642, 1522, 1532, 1586, 1612, 1520, 1642, 1645, 1624, 1602, 1628, 1592, 1655, 1524, 1581, 1576, 1628, 1572, 1568, 1620, 1604, 1636, 1696, 1666, 1788, 1600, 1722, 1754, 1612, 1628, 1706, 1770, 1721, 1820, 1760, 1647, 1848, 1759, 1824, 1788, 1880, 1964, 1845, 1949, 2036, 1857, 2054, 1944, 1936, 1974, 2070, 2000, 1982, 1974, 2066, 1950, 2034, 1976, 1990, 2018, 2038, 1988, 1957, 2012, 2032, 2040, 1976, 2046, 1952, 1930, 2106, 2046, 1984, 2012, 2058, 2070, 1913, 1920, 2020, 2092, 2013, 2022, 2028, 1911, 2078, 1964, 2009, 2006, 1996, 1970, 1992, 1918, 1936, 1978, 1878, 2040, 1998, 1918, 1908, 2082, 1932, 1968, 2044, 1905, 1866, 1904, 1839, 1954, 1834, 1824, 1738, 1732, 1806, 1680, 1623, 1550, 1490, 1724, 1430, 1624, 1602, 1495, 1508, 1520, 1626, 1586, 1576, 1448, 1548, 1636, 1576, 1584, 1565, 1488, 1590, 1584, 1581, 1646, 1552, 1612, 1640, 1616, 1582, 1650, 1561, 1588, 1598, 1576, 1737, 1602, 1578, 1626, 1500, 1564, 1590, 1520, 1573, 1576, 1444, 1508, 1559, 1484, 1535, 1536, 1535, 1508, 1504, 1553, 1566, 1516, 1580, 1484, 1550, 1474, 1498, 1534, 1430, 1490, 1492, 1532, 1534, 1538, 1472, 1498, 1563, 1625, 1648, 1611, 1634, 1692, 1631, 1695, 1762, 1666, 1780, 1688, 1732, 1752, 1663, 1758, 1642, 1768, 1706, 1730, 1734, 1683, 1726, 1852, 1728, 1892, 1808, 1846, 1845, 1932, 1924, 1912, 1960, 1968, 2000, 1874, 1670, 1733, 1698, 1766, 1708, 1537, 1472, 1557, 1646, 1544, 1712, 1792, 1884, 2042, 1956, 1932, 1792, 1394, 1490, 1740, 2030, 1764, 1508, 1820, 1534, 1922, 1774, 1640, 2188, 1562, 1960, 1680, 1850, 1745, 1712, 1552, 1658, 1820, 1548, 1509, 1622, 1640, 1549, 1974, 1715, 1638, 1662, 1714, 1938, 1909, 1576, 1776, 1728, 1836, 1925, 1760, 1750, 1794, 1824, 1878, 1810, 1718, 1854, 1756, 1908, 1872, 1742, 1880, 1778, 1830, 1902, 1808, 1904, 1785, 1832, 1790, 1824, 1786, 1726, 1788, 1876, 1860, 1820, 1767, 1806, 1694, 1780, 1788, 1774, 1842, 1846, 1790, 1660, 1786, 1646, 1812, 1704, 1750, 1780, 1788, 1796, 1740, 1692, 1806, 1766, 1722, 1744, 1692, 1794, 1775, 1714, 1686, 1828, 1690, 1614, 1759, 1812, 1766, 1719, 1754, 1744, 1682, 1680, 1620, 1698, 1612, 1748, 1754, 1738, 1688, 1802, 1786, 1723, 1740, 1868, 1714, 1746, 1694, 1749, 1710, 1836, 1770, 1800, 1644, 1766, 1796, 1811, 1827, 1742, 1700, 1702, 1810, 1678, 1732, 1784, 1828, 1758, 1726, 1721, 1736, 1768, 1698, 1676, 1743, 1674, 1882, 1766, 1729, 1847, 1708, 1735, 1822, 1820, 1671, 1848, 1782, 1712, 1776, 1619, 1754, 1705, 1714, 1906, 1823, 1834, 1724, 1702, 1743, 1766, 1790, 1750, 1714, 1730, 1732, 1855, 1686, 1782, 1800, 1688, 1736, 1784, 1761, 1730, 1696, 1804, 1696, 1770, 1759, 1786, 1870, 1754, 1744, 1712, 1728, 1671, 1780, 1735, 1716, 1634, 1844, 1622, 1672, 1709, 1696, 1720, 1782, 1751, 1742, 1764, 1764, 1680, 1720, 1814, 1790, 1788, 1730, 1830, 1827, 1652, 1852, 1828, 1902, 1790, 1723, 1726, 1728, 1760, 1780, 1766, 1734, 1768, 1814, 1764, 1706, 1824, 1856, 1838, 1822, 1832, 1828, 1692, 1770, 1800, 1841, 1816, 1692, 1792, 1788, 1806, 1784, 1698, 1810, 1732, 1740, 1724, 1831, 1698, 1864, 1778, 1890, 1719, 1876, 1759, 1836, 1698, 1678, 1812, 1736, 1881, 1732, 1718, 1718, 1752, 1877, 1718, 1668, 1712, 1734, 1746, 1692, 1690, 1704, 1745, 1748, 1805, 1668, 1806, 1786, 1739, 1724, 1823, 1816, 1744, 1788, 1760, 1848, 1799, 1880, 1738, 1800, 1751, 1748, 1830, 1834, 1640, 1780, 1796, 1786, 1834, 1797, 1882, 1832, 1793, 1804, 1858, 1702, 1673, 1748, 1784, 1694, 1656, 1688, 1708, 1752, 1774, 1810, 1747, 1650, 1678, 1740, 1700, 1620, 1772, 1690, 1799, 1740, 1774, 1814, 1752, 1688, 1730, 1826, 1826, 1786, 1672, 1734, 1631, 1710, 1819, 1750, 1756, 1752, 1802, 1854, 1679, 1746, 1745, 1684, 1858, 1617, 1706, 1698, 1684, 1694, 1660, 1866, 1774, 1732, 1691, 1694, 1794, 1826, 1657, 1758, 1788, 1758, 1794, 1750, 1781, 1756, 1794, 1706, 1684, 1745, 1737, 1814, 1650, 1682, 1838, 1872, 1648, 1562, 1772, 1716, 1782, 1688, 1762, 1720, 1662, 1716, 1729, 1834, 1670, 1624, 1804
};

int get_feature_data(size_t offset, size_t length, float *out_ptr) {
    memcpy(out_ptr, features + offset, length * sizeof(float));
    return 0;
}

void task_radar()
{
	/* Suppress warning for unused parameter */
	//(void)param;

	cy_rslt_t result = CY_RSLT_SUCCESS;

	/* Initialize the device and board peripherals. */
	result = cybsp_init();
	CY_ASSERT(result == CY_RSLT_SUCCESS);

	__enable_irq();

	/* Initialize retarget-io to use the debug UART port. */
	result = cy_retarget_io_init(CYBSP_DEBUG_UART_TX, CYBSP_DEBUG_UART_RX, CY_RETARGET_IO_BAUDRATE);
	CY_ASSERT(result == CY_RSLT_SUCCESS);

	printf("XENSIV BGT60TRxx Example\r\n");

	/* Initialize the SPI interface to BGT60. */
	    result = cyhal_spi_init(&cyhal_spi,
	                            PIN_XENSIV_BGT60TRXX_SPI_MOSI,
	                            PIN_XENSIV_BGT60TRXX_SPI_MISO,
	                            PIN_XENSIV_BGT60TRXX_SPI_SCLK,
	                            NC,
	                            NULL,
	                            8,
	                            CYHAL_SPI_MODE_00_MSB,
	                            false);
	    CY_ASSERT(result == CY_RSLT_SUCCESS);

	    /* Reduce drive strength to improve EMI */
	    Cy_GPIO_SetSlewRate(CYHAL_GET_PORTADDR(PIN_XENSIV_BGT60TRXX_SPI_MOSI),
	                        CYHAL_GET_PIN(PIN_XENSIV_BGT60TRXX_SPI_MOSI), CY_GPIO_SLEW_FAST);
	    Cy_GPIO_SetDriveSel(CYHAL_GET_PORTADDR(PIN_XENSIV_BGT60TRXX_SPI_MOSI),
	                        CYHAL_GET_PIN(PIN_XENSIV_BGT60TRXX_SPI_MOSI), CY_GPIO_DRIVE_1_8);
	    Cy_GPIO_SetSlewRate(CYHAL_GET_PORTADDR(PIN_XENSIV_BGT60TRXX_SPI_SCLK),
	                        CYHAL_GET_PIN(PIN_XENSIV_BGT60TRXX_SPI_SCLK), CY_GPIO_SLEW_FAST);
	    Cy_GPIO_SetDriveSel(CYHAL_GET_PORTADDR(PIN_XENSIV_BGT60TRXX_SPI_SCLK),
	                        CYHAL_GET_PIN(PIN_XENSIV_BGT60TRXX_SPI_SCLK), CY_GPIO_DRIVE_1_8);

	    /* Set SPI data rate to communicate with sensor */
	    result = cyhal_spi_set_frequency(&cyhal_spi, XENSIV_BGT60TRXX_SPI_FREQUENCY);
	    CY_ASSERT(result == CY_RSLT_SUCCESS);

	    /* Enable the LDO. */
	    result = cyhal_gpio_init(PIN_XENSIV_BGT60TRXX_LDO_EN,
	                             CYHAL_GPIO_DIR_OUTPUT,
	                             CYHAL_GPIO_DRIVE_STRONG,
	                             true);
	    CY_ASSERT(result == CY_RSLT_SUCCESS);

	    /* Wait LDO stable */
	    (void)cyhal_system_delay_ms(5);

	    result = xensiv_bgt60trxx_mtb_init(&sensor,
	                                       &cyhal_spi,
	                                       PIN_XENSIV_BGT60TRXX_SPI_CSN,
	                                       PIN_XENSIV_BGT60TRXX_RSTN,
	                                       register_list,
	                                       XENSIV_BGT60TRXX_CONF_NUM_REGS);
	    CY_ASSERT(result == CY_RSLT_SUCCESS);

	    /* The sensor will generate an interrupt once the sensor FIFO level is
	       NUM_SAMPLES_PER_FRAME */
	    result = xensiv_bgt60trxx_mtb_interrupt_init(&sensor,
	                                                 NUM_SAMPLES_PER_FRAME,
	                                                 PIN_XENSIV_BGT60TRXX_IRQ,
	                                                 CYHAL_ISR_PRIORITY_DEFAULT,
	                                                 xensiv_bgt60trxx_mtb_interrupt_handler,
	                                                 NULL);
	    CY_ASSERT(result == CY_RSLT_SUCCESS);


	    if (xensiv_bgt60trxx_start_frame(&sensor.dev, true) != XENSIV_BGT60TRXX_STATUS_OK)
	    {
	        CY_ASSERT(0);
	    }

	    uint32_t frame_idx = 0;

//	    for(;;)
//	    {
//	    	/* Wait for the radar device to indicate the availability of the data to fetch. */
//	    	while (data_available == false);
//	        data_available = false;
//
//	        if (xensiv_bgt60trxx_get_fifo_data(&sensor.dev, samples,
//	                                            NUM_SAMPLES_PER_FRAME) == XENSIV_BGT60TRXX_STATUS_OK)
//	        {
//	          	//printf("Some data here");
//	           	//printf("%" PRIu16 "\n", *samples);
//	           	printf("%d\n", *samples);
//	        }
//	    }

	    int total_length = sizeof(features) / sizeof(features[0]);
	    ei_impulse_result_t ei_result = { 0 };

	    // Edge Impulse Inference
	    while (1) {
	    	/* Wait for the radar device to indicate the availability of the data to fetch. */
	    	while (data_available == false);
	    	data_available = false;

	    	if (xensiv_bgt60trxx_get_fifo_data(&sensor.dev, samples,
	    		                               NUM_SAMPLES_PER_FRAME) == XENSIV_BGT60TRXX_STATUS_OK)
	    	{
	    		// Collect data into the array
	    		for (int i = 0; i < NUM_SAMPLES_PER_FRAME; i++) {
	    			features[i] = samples[i];
	    		}
	    	}

	    	// Do classification
	    	ei_c_wrapper_run_classifier(
	    			total_length,
	    		    &get_feature_data,
	    		    &ei_result,
	    		    true);

	    	// Find the largest value
	    	/*float max_value = 0;
	    	for (size_t ix = 0; ix < EI_CLASSIFIER_LABEL_COUNT; ix++) {
	    		float current = ei_result.classification[ix].value;
	    		char * label = (char *) ei_result.classification[ix].label;
	    		if (current > max_value) {
	    			max_value = current;
	    		    strncpy(gesture_text, label, 20);
	    		}
	    	}*/

	        // Print to screen
	        for (size_t ix = 0; ix < EI_CLASSIFIER_LABEL_COUNT; ix++) {
	            printf("%s:%.5f",
	                    ei_result.classification[ix].label,
	                    ei_result.classification[ix].value
	            );
	        }
	    }
}

int main(void)
{
	cy_rslt_t result;

	/* Initialize the device and board peripherals */
	result = cybsp_init();

	/* Board init failed. Stop program execution */
	if (result != CY_RSLT_SUCCESS)
	{
		CY_ASSERT(0);
	}

	/* Enable global interrupts */
	__enable_irq();

	/* Initialize retarget-io to use the debug UART port */
	result = cy_retarget_io_init(CYBSP_DEBUG_UART_TX, CYBSP_DEBUG_UART_RX,
	                                 CY_RETARGET_IO_BAUDRATE);

	/* retarget-io init failed. Stop program execution */
	if (result != CY_RSLT_SUCCESS)
	{
		CY_ASSERT(0);
	}

	/* Initialize the User LED */
	result = cyhal_gpio_init(CYBSP_USER_LED, CYHAL_GPIO_DIR_OUTPUT,
	                             CYHAL_GPIO_DRIVE_STRONG, CYBSP_LED_STATE_OFF);

	/* GPIO init failed. Stop program execution */
	if (result != CY_RSLT_SUCCESS)
	{
		CY_ASSERT(0);
	}

	/* \x1b[2J\x1b[;H - ANSI ESC sequence for clear screen */
	printf("\x1b[2J\x1b[;H");

	printf("****************** "
	           "PSoC 6 MCU: Hello World! Example "
	           "****************** \r\n\n");
	printf("Hi\r\n");
	task_radar();
}

/* END OF FILE [] */
